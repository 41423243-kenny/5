{% extends "base.html" %}

{% block title %}Brython éŠæˆ²{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython_stdlib.js"></script>

<h2 style="text-align: center;">ğŸ•¹ï¸ é»æ“Šæ¸¬è©¦ï¼šé»æ“Šç§»å‹•ä¸­çš„åœ“å½¢ï¼</h2>

<div id="brython_div1" style="width: 600px; height: 400px; margin: 20px auto;"></div>

{% raw %}
<script type="text/python">
from browser import document, timer, window
import random
import time

# =========================
# éŠæˆ²è¨­å®š
# =========================
GAME_DURATION = 30
TARGET_SIZE = 50
MOVE_INTERVAL = 800

score = 0
game_active = False
targets = []

# =========================
# éŠæˆ²å€è¨­å®š
# =========================
game_area = document["brython_div1"]
game_area.style.border = "3px solid #333"
game_area.style.backgroundColor = "#e0e0ff"
game_area.style.position = "relative"
game_area.style.overflow = "hidden"
game_area.style.cursor = "crosshair"

# =========================
# åˆ†æ•¸é¡¯ç¤º
# =========================
score_display = document.createElement("div")
score_display.style.position = "absolute"
score_display.style.top = "10px"
score_display.style.left = "10px"
score_display.style.fontSize = "1.2em"
score_display.style.fontWeight = "bold"
game_area <= score_display

# =========================
# æ™‚é–“é¡¯ç¤º
# =========================
timer_display = document.createElement("div")
timer_display.style.position = "absolute"
timer_display.style.top = "10px"
timer_display.style.right = "10px"
timer_display.style.fontSize = "1.2em"
timer_display.style.fontWeight = "bold"
game_area <= timer_display

# =========================
# ä½¿ç”¨è€…è¼¸å…¥ï¼ˆåœ“é»æ•¸é‡ï¼‰
# =========================
input_box = document.createElement("input")
input_box.type = "number"
input_box.value = "3"
input_box.min = "1"
input_box.style.position = "absolute"
input_box.style.bottom = "10px"
input_box.style.left = "10px"
game_area <= input_box

label = document.createElement("span")
label.text = " åœ“é»æ•¸é‡"
label.style.position = "absolute"
label.style.bottom = "12px"
label.style.left = "70px"
game_area <= label

# =========================
# å»ºç«‹åœ“é»
# =========================
def create_targets():
    global targets

    # æ¸…é™¤èˆŠåœ“é»
    for t in targets:
        t.remove()
    targets.clear()

    # é˜²å‘†è™•ç†
    try:
        count = max(1, int(input_box.value))
    except:
        count = 1

    for _ in range(count):
        target = document.createElement("div")
        target.style.width = f"{TARGET_SIZE}px"
        target.style.height = f"{TARGET_SIZE}px"
        target.style.borderRadius = "50%"
        target.style.position = "absolute"
        target.style.cursor = "pointer"
        target.style.backgroundColor = "red"

        @target.bind("click")
        def hit(ev):
            global score
            if not game_active:
                return
            score += 1
            score_display.text = f"åˆ†æ•¸: {score}"
            move_targets()
            ev.stopPropagation()

        game_area <= target
        targets.append(target)

# =========================
# ç§»å‹•åœ“é»
# =========================
def move_targets():
    if not game_active:
        return

    max_x = game_area.clientWidth - TARGET_SIZE
    max_y = game_area.clientHeight - TARGET_SIZE

    for t in targets:
        t.style.left = f"{random.randint(0, max_x)}px"
        t.style.top = f"{random.randint(40, max_y)}px"
        t.style.backgroundColor = (
            f"rgb({random.randint(0,255)},"
            f"{random.randint(0,255)},"
            f"{random.randint(0,255)})"
        )

# =========================
# å³æ™‚æ›´æ–°åœ“é»æ•¸é‡ï¼ˆâ­ é—œéµä¿®æ­£ï¼‰
# =========================
@input_box.bind("change")
def update_targets(ev):
    if game_active:
        create_targets()
        move_targets()

# =========================
# è¨ˆæ™‚æª¢æŸ¥
# =========================
def check_time():
    global game_active
    remaining = int(game_over_time - time.time())

    if remaining <= 0:
        timer_display.text = "æ™‚é–“: 0s"
        game_active = False
        timer.clear_interval(move_handle)

        # ç¦æ­¢å†é»æ“Š
        for t in targets:
            t.style.pointerEvents = "none"

        window.alert(f"éŠæˆ²çµæŸï¼åˆ†æ•¸ï¼š{score}")
    else:
        timer_display.text = f"æ™‚é–“: {remaining}s"
        timer.set_timeout(check_time, 1000)

# =========================
# å•Ÿå‹•éŠæˆ²
# =========================
def start_game():
    global score, game_active, game_over_time, move_handle

    score = 0
    game_active = True
    score_display.text = "åˆ†æ•¸: 0"
    timer_display.text = f"æ™‚é–“: {GAME_DURATION}s"

    create_targets()
    move_targets()

    game_over_time = time.time() + GAME_DURATION
    check_time()
    move_handle = timer.set_interval(move_targets, MOVE_INTERVAL)

start_game()
</script>
{% endraw %}

<script>
  brython({debug: 1});
</script>
{% endblock %}